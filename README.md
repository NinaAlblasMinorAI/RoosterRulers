# Rooster Rulers' Project: the Perfect Schedule

In this case, a week schedule is created for a list of courses on UvA Science Park.
- Courses consist of lectures and/or tutorials and/or labs. There is a maximum number of students defined for each tutorial and lab.
- There are seven rooms of varying capacities, and each room is suited to host lectures, tutorials, as well as labs.
- All lectures, tutorials, and labs need to be placed in a time slot. The available time slots are 09:00-11:00, 11:00-13:00, 13:00-15:00, or 15:00-17:00, from Monday to Friday. The largest room (C0.110) also has an evening slot (17:00-19:00). This makes for a total of 145 available room-time slots.
- A week schedule is valid when all lectures, tutorials, and labs (i.e., "lessons") are assigned a room-time slot and no students have 3 adjacent free periods between lessons.
- A room-time slot can only be used for one lesson at a time.
- Each student has an individual schedule.
The goal is to create a schedule in which students fit into the rooms they are placed in as often as possible, and in which the number of evening slots, lesson conflicts, and free periods is minimized.


## Getting Started

### Prerequisites

This codebase was completely written in [Python3.8.10](https://www.python.org/downloads/). In requirements.txt the user can find all the required packages to succesfully run the code. These are easily installed through pip using the following command:

```
pip install -r requirements.txt
```

### Structure

The files are divided into the following folders:
- code: all Python scripts, including the following subfolders:
    - algorithms
    - classes
    - trash (obsolete code)
    - visualization

- doc: documents, e.g. presentations
- input_data: the input data for the case, e.g. the .csv file with the courses
- output_data: the output data generated by the scripts (with example output)


### Running

Use the command below to run the code. For distributing the lessons over the schedule, the user can choose from the 'random', 'hillclimber', and 'simulated_annealing' algorithm. For distributing the students over the lessons, the 'hillclimber' algorithm is always used, so this does not need to be specified.

```
python main.py <algorithm> 
```

Following command line arguments are available:
- -n -> total number of runs for the algorithm
- -O -> number of optimize runs using extra lessons
- -c -> number of extra lessons to create per optimize run
- -r -> number of repeats for redistributing lessons; for 'hillclimber', it is the number of iterations that the objective value does not change before the algorithm stops, for 'simulated annealing', it is the total number of iterations.
- -o -> number of outer repeats for redistributing students; the number of iterations that all non-lecture lessons of the same type from a single course are selected and the objective value does not change before the algorithm stops 
- -i -> number of inner repeats for redistributing students; the number of iterations that two students are selected and the objective value does not change before the algorithm stops
- -t -> starting temperature for 'simulated annealing'
- -v -> verbose; boolean that indicates extra logging on the command prompt


Use the command below to print the malus points and to generate a csv output and a Bokeh schedule from an existing pickle file containing a schedule 

```
python load_pickle.py <pickle file name in output_data> 
```

## Output files
The following files are generated for each hillclimber and simulated annealing run in folder output_data:
- A log file with the intermediate and final results of each run.
- A line plot of the iterations (x-axis) and number of malus points (y-axis)
- A pickle file of the best schedule 
- A bokeh output of the best schedule 
- A CSV output of the roster of all students from the best schedule
- A box_plot of the results of each run

## Algorithms
The algorithms below are used. First lessons are redistributed, then students are redistributed and then extra lessons are generated. This proces can be repeated a number of times. In the last repeat, no extra lessons are generated.
- random -> the random algoritm is used for generating a first schedule, which can be optimized. The minimum amount of lessons are created taking into account the maximum number of students per lesson (for lab and tutorials). Students are evenly distributed over these lessons. Constraint relaxation is used for 3 free periods between 2 lessons. This is illegal, but instead 100 malus points are assigned. 
- hillclimber -> the hillclimber algorithm is used for distributing the lessons over the schedule and for distributing the students over the lessons. 
    - hillclimber for lessons -> when distributing the lessons over the schedule, two random locations are swapped. These locations can be either lessons or empty slots. If the swap leads to less malus points, the change is retained, otherwise it is reversed. If the score is not improved for a specified number of runs, the algorithm stops.
    - hillclimber for students -> the hillclimber for students picks a random lesson. After that, if finds the other lessons of the same course and type (tutorial or lab). After that, it swapps two random students (or open spots in the lesson) between these lessons. After each swap the malus points are calculated. If the number of malus points becomes lower, the change is retained, otherwise it is reversed. If the malus points do not decrease after a specified number of iterations of student swapping, this part stops, and a new random lesson is selected for swapping students. If swapping students after choosing a random lesson does not improve for a specified number of iterations, the algorithm stops.
- simulated annealing for lessons -> the simulated annealing algorithm is used for swapping lessons. Two random lessons are swapped. The chance of exepting the change is calculated with the function below:  
chance = 2 ** (old malus points â€“ new malus points) / temperature  
This change is compared against a random number between 0 and 1. It the chance is higher than the random number, the change is retained, otherwise it is reversed. That means that sometimes increases in malus points are accepted. 
With each iteration the temperature decreases. That means that in the beginning, more increases in malus points are retained that in the end. 
- greedy algorithm -> for creating extra lessons, a greedy algorithm is used. After a run of lesson and student algorithms, a specified number of extra lessons are created based on the lessons with the most malus points.
       
## Authors

* Nina Alblas
* Marc Jurriens
* Dennis Vlegels


## Acknowledgments

* Mayla Kersten and Quinten van der Post